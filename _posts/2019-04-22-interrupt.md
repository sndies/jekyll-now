---
layout: post
title:  "linux内核学习笔记- 中断"
date:   2019-04-22 22:25:43 +0800
categories: jekyll update
---


---


### 概念
  
  中断本质上是一种特殊的电信号，硬件设备生成中断的时候并不考虑与处理器的时钟同步
  
  异常的产生必须考虑处理器时钟同步，异常也成为同步中断。如处理器执行到异常指令或缺页或系统调用等必须靠内核来处理时，处理器就会产生一个异常。
 
  在响应一个特定中断的时候，内核会执行一个函数，即中断处理程序，产生中断的每个设备都有一个相应的中断处理程序。
  
<br/>

### 组成
  
  一般把中断处理切为两个部分：上半部和下半部，上半部只做有严格时限的工作。
  
  每块设备都有相关的驱动程序，如果设备使用中断，那么相应的驱动程序就注册一个中断处理程序。
  
  linux中的中断处理程序是无须重入的。当一个给定的中断处理程序在执行时，相应的中断线在所有处理器上都会被屏蔽掉，以防止在同一中断线上接受另一个新的中断。
  
  当内核接收到一个中断后，将以次调用在该中断线上注册的每一个处理程序。如果程序发现与它相关的设备并没有产生中断，那该程序就退出。
  
<br/>

### 中断上下文
  
> 中断上下文不能睡眠
  
  进程的内核栈的大小是两页，32为体系结构是8KB，64为体系结构是16KB。后续版本提供了一个选项可以把栈的大小从两页减到一页。
  
  为了应对栈大小的减少，中断处理程序用了自己的栈，大小一页。
  
  
  图：截自linux kernel design and implement

<br/>

### 中断控制
  
  禁止中断可以确保某个中断处理程序不会抢占当前的代码，还可以禁止内核抢占。
  
  然而不管是禁止中断还是禁止内核抢占，都没有提供任何保护机制来防止来自其他处理器的并发访问。
  
  内核代码一般都需要获取某种锁防止来自其他处理器对共享数据的并发访问。获取这些锁的同时也伴随着禁止本地中断。两者提供的保护机制不同，锁防止来自其他处理器的并发方案，禁止中断防止来自其他中断处理程序的并发访问。

[jekyll-docs]: https://jekyllrb.com/docs/home
[jekyll-gh]:   https://github.com/jekyll/jekyll
[jekyll-talk]: https://talk.jekyllrb.com/
